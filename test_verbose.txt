
> teste-tecnico-backend-2025-trimestre-4@0.0.1 test /Users/gabriel/www/private/teste-tecnico-backend-2025-trimestre-4
> jest --verbose

PASS src/decorators/response/api.get.response.decorator.spec.ts
  ApiGetResponse
    âœ“ should be defined and return a function (4 ms)

[31m[Nest] 21494  - [39m02/04/2026, 3:09:31 PM [31m  ERROR[39m [38;5;3m[AddressService] [39m[31mAll address providers failed for CEP 01001000[39m
PASS src/services/address.service.spec.ts
  AddressService
    getAddress
      âœ“ should return address from ViaCEP if successful (8 ms)
      âœ“ should try OpenCEP if ViaCEP fails (2 ms)
      âœ“ should return null if all providers fail (3 ms)
      âœ“ should catch and log provider errors and continue (3 ms)

PASS src/decorators/response/api.not-found.response.decorator.spec.ts
  ApiNotFoundResponse
    âœ“ should be defined and return a function (4 ms)

PASS src/controllers/cep.crawl.results.controller.spec.ts
  CepCrawlResultsController
    main
      âœ“ should call handler with correct params and return response (18 ms)

PASS src/responses/cep.crawl.create.response.spec.ts
  CepCrawlCreateResponse
    âœ“ should map properties correctly

PASS src/handlers/cep.crawl.results.handler.spec.ts
  CepCrawlResultsHandler
    main
      âœ“ should return CepCrawlResultsResponse with data when crawl exists (24 ms)
      âœ“ should return CepCrawlNotFoundResponse when crawl does not exist (2 ms)
      âœ“ should use default pagination values if not provided (1 ms)

[31m[Nest] 21490  - [39m02/04/2026, 3:09:32 PM [31m  ERROR[39m [38;5;3m[CrawlWorker] [39m[31mFailed to process message unknown[39m
Unexpected token 'i', "invalid-json" is not valid JSON
[31m[Nest] 21490  - [39m02/04/2026, 3:09:31 PM [31m  ERROR[39m [38;5;3m[CrawlWorker] [39m[31mPolling error[39m
SQS Down
[31m[Nest] 21490  - [39m02/04/2026, 3:09:31 PM [31m  ERROR[39m [38;5;3m[CrawlWorker] [39m[31mFailed to start polling[39m
Init Fail
PASS src/workers/crawl.worker.spec.ts
  CrawlWorker
    processMessages
      âœ“ should process a message, fetch address, and delete message (17 ms)
      âœ“ should handle missing address and save error result (3 ms)
      âœ“ should handle transient error and throw (triggering retry logic) (1 ms)
    startPolling
      âœ“ should not start if role is not worker
      âœ“ should start polling and process messages if role is worker (1 ms)
      âœ“ should log error if JSON parsing fails (1 ms)
      âœ“ should handle polling error and wait 5s (1 ms)
    onModuleInit
      âœ“ should log error if startPolling fails (1 ms)

[31m[Nest] 21492  - [39m02/04/2026, 3:09:31 PM [31m  ERROR[39m [38;5;3m[SqsService] [39m[31mError creating queue: Queue Error[39m
[31m[Nest] 21492  - [39m02/04/2026, 3:09:31 PM [31m  ERROR[39m [38;5;3m[SqsService] [39m[31mError receiving messages from SQS: Recv Error[39m
[31m[Nest] 21492  - [39m02/04/2026, 3:09:31 PM [31m  ERROR[39m [38;5;3m[SqsService] [39m[31mError deleting message from SQS: Del Error[39m
[31m[Nest] 21492  - [39m02/04/2026, 3:09:31 PM [31m  ERROR[39m [38;5;3m[SqsService] [39m[31mError sending message to SQS: SQS Error[39m
[31m[Nest] 21492  - [39m02/04/2026, 3:09:31 PM [31m  ERROR[39m [38;5;3m[SqsService] [39m[31mError sending batch to SQS: Batch Error[39m
PASS src/services/sqs.service.spec.ts
  SqsService
    âœ“ should initialize on module init (mocking existsSync) (16 ms)
    âœ“ should initialize on module init for Docker (1 ms)
    âœ“ should handle error when creating queue (2 ms)
    âœ“ should send a single message (1 ms)
    âœ“ should send messages in batches of 10 (1 ms)
    âœ“ should receive messages (2 ms)
    âœ“ should return empty array when Messages is undefined (1 ms)
    âœ“ should return empty array when receive fails (2 ms)
    âœ“ should delete a message (1 ms)
    âœ“ should handle error when delete fails (2 ms)
    âœ“ should handle errors when sending fails (16 ms)
    âœ“ should handle errors when batch fails (1 ms)

PASS src/repositories/crawl.repository.spec.ts
  CrawlRepository
    âœ“ should create a crawl (5 ms)
    âœ“ should findById (2 ms)
    âœ“ should update a crawl (1 ms)
    âœ“ should updateWithSelect
    âœ“ should createResults (2 ms)
    âœ“ should createSingleResult (1 ms)
    âœ“ should findResults (2 ms)
    âœ“ should countResults (2 ms)

PASS src/handlers/cep.crawl.create.handler.spec.ts
  CepCrawlCreateHandler
    main
      âœ“ should create a crawl and enqueue missing ceps (Happy Path) (18 ms)
      âœ“ should apply cache and not enqueue if all CEPs are cached (3 ms)
      âœ“ should return CepCrawlNotFoundResponse if crawl goes missing after creation (3 ms)

PASS src/controllers/health.controller.spec.ts
  HealthController
    check
      âœ“ should return status OK and a timestamp (7 ms)

PASS src/services/cep-cache.service.spec.ts
  CepCacheService
    save
      âœ“ should save a found address (2 ms)
      âœ“ should save a NOT found status (1 ms)
    findMethods
      âœ“ should delegate findMany to repository (2 ms)
      âœ“ should delegate findUnique to repository (2 ms)

PASS src/dtos/cep.crawl.get.dto.spec.ts
  CepCrawlGetDTO
    âœ“ should hold crawl_id (1 ms)

PASS src/controllers/cep.crawl.create.controller.spec.ts
  CepCrawlCreateController
    main
      âœ“ should call handler and return response with correct status (13 ms)

PASS src/dtos/cep.crawl.create.dto.spec.ts
  CepCrawlCreateDTO
    âœ“ should hold input properties

PASS src/decorators/response/api.results.response.decorator.spec.ts
  ApiResultsResponse
    âœ“ should be defined and return a function (1 ms)

PASS src/decorators/response/api.create.response.decorator.spec.ts
  ApiCreateResponse
    âœ“ should be defined and return a function (1 ms)

[31m[Nest] 21496  - [39m02/04/2026, 3:09:31 PM [31m  ERROR[39m [38;5;3m[ViaCepProvider] [39m[31mViaCEP failed for 01001000: Network Error[39m
PASS src/providers/viacep.provider.spec.ts
  ViaCepProvider
    âœ“ should return address data when request is successful (1 ms)
    âœ“ should return null when ViaCEP returns an error flag
    âœ“ should return null and log warning when request fails (2 ms)

PASS src/responses/bad-request.response.spec.ts
  BadRequestResponse
    âœ“ should initialize with default message
    âœ“ should initialize with custom message (1 ms)

PASS src/responses/health.response.spec.ts
  HealthResponse
    âœ“ should hold status and timestamp (1 ms)

PASS src/handlers/cep.crawl.get.handler.spec.ts
  CepCrawlGetHandler
    main
      âœ“ should return CepCrawlGetResponse when crawl exists (4 ms)
      âœ“ should return CepCrawlNotFoundResponse when crawl does not exist (1 ms)

PASS src/repositories/cep.repository.spec.ts
  CepRepository
    âœ“ should findMany ceps (3 ms)
    âœ“ should findUnique cep (2 ms)

PASS src/validators/cep-range.validator.spec.ts
  IsCepRangeConstraint
    âœ“ should return true for valid range
    âœ“ should return false if cep_start > cep_end
    âœ“ should return false if range > 10000
    âœ“ should return false if invalid format (1 ms)

[31m[Nest] 21490  - [39m02/04/2026, 3:09:31 PM [31m  ERROR[39m [38;5;3m[OpenCepProvider] [39m[31mOpenCEP failed for 01001000: Timeout[39m
PASS src/providers/opencep.provider.spec.ts
  OpenCepProvider
    âœ“ should return address data when request is successful (1 ms)
    âœ“ should return null when OpenCEP returns 404
    âœ“ should return null when request fails with other error (1 ms)

PASS src/responses/cep.crawl.not-found.response.spec.ts
  CepCrawlNotFoundResponse
    âœ“ should have code 404

PASS src/services/crawl.service.spec.ts
  CrawlService
    âœ“ should find results (1 ms)
    âœ“ should count results using countResults (2 ms)
    âœ“ should count results using findResultsCount (1 ms)
    âœ“ should create a crawl findById (2 ms)
    âœ“ should increment failed_ceps when status is ERROR (2 ms)
    createCrawl
      âœ“ should create a crawl with PENDING status (1 ms)
    processBulkCachedResults
      âœ“ should set status to FINISHED if range is complete (11 ms)
      âœ“ should set status to RUNNING if range is NOT complete (1 ms)
    saveSingleResult
      âœ“ should update status to FINISHED when all ceps are processed
      âœ“ should update status to RUNNING when NOT all ceps are processed

PASS src/responses/cep.crawl.get.response.spec.ts
  CepCrawlGetResponse
    âœ“ should map properties correctly (1 ms)

PASS src/dtos/cep.crawl.results.get.dto.spec.ts
  CepCrawlResultsGetDTO
    âœ“ should hold query properties (1 ms)

PASS src/constants/http-response-messages.constant.spec.ts
  HttpResponseMessages
    âœ“ should have OK message
    âœ“ should have NOT_FOUND message (1 ms)
    âœ“ should have BAD_REQUEST message

PASS src/services/prisma.service.spec.ts
  PrismaService
    âœ“ should connect on module init (38 ms)
    âœ“ should disconnect on module destroy (2 ms)

PASS src/controllers/cep.crawl.get.controller.spec.ts
  CepCrawlGetController
    main
      âœ“ should call handler with crawlId and return response (1 ms)

PASS src/responses/cep.crawl.results.response.spec.ts
  CepCrawlResultsResponse
    âœ“ should map results and pagination correctly

Test Suites: 32 passed, 32 total
Tests:       89 passed, 89 total
Snapshots:   0 total
Time:        1.635 s, estimated 2 s
Ran all test suites.
